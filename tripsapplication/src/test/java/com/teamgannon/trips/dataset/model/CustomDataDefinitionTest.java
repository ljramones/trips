package com.teamgannon.trips.dataset.model;

import com.teamgannon.trips.dataset.enums.CustomFieldType;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import java.util.Arrays;
import java.util.List;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("CustomDataDefinition Tests")
class CustomDataDefinitionTest {

    private CustomDataDefinition definition;

    @BeforeEach
    void setUp() {
        definition = new CustomDataDefinition();
    }

    @Nested
    @DisplayName("Basic Properties Tests")
    class BasicPropertiesTests {

        @Test
        @DisplayName("should have auto-generated UUID on creation")
        void shouldHaveAutoGeneratedUuid() {
            assertNotNull(definition.getId());
        }

        @Test
        @DisplayName("should set and get custom field name")
        void shouldSetAndGetCustomFieldName() {
            definition.setCustomFieldName("Population");

            assertEquals("Population", definition.getCustomFieldName());
        }

        @Test
        @DisplayName("should set and get custom field type")
        void shouldSetAndGetCustomFieldType() {
            definition.setCustomFieldType(CustomFieldType.INT);
            assertEquals(CustomFieldType.INT, definition.getCustomFieldType());

            definition.setCustomFieldType(CustomFieldType.DOUBLE);
            assertEquals(CustomFieldType.DOUBLE, definition.getCustomFieldType());

            definition.setCustomFieldType(CustomFieldType.TEXT);
            assertEquals(CustomFieldType.TEXT, definition.getCustomFieldType());

            definition.setCustomFieldType(CustomFieldType.MULTIPLE);
            assertEquals(CustomFieldType.MULTIPLE, definition.getCustomFieldType());
        }

        @Test
        @DisplayName("should set and get custom field width")
        void shouldSetAndGetCustomFieldWidth() {
            definition.setCustomFieldWidth("100");

            assertEquals("100", definition.getCustomFieldWidth());
        }

        @Test
        @DisplayName("should have empty options list by default")
        void shouldHaveEmptyOptionsListByDefault() {
            assertNotNull(definition.getCustomFieldOptions());
            assertTrue(definition.getCustomFieldOptions().isEmpty());
        }

        @Test
        @DisplayName("should set and get custom field options")
        void shouldSetAndGetCustomFieldOptions() {
            List<String> options = Arrays.asList("Option1", "Option2", "Option3");
            definition.setCustomFieldOptions(options);

            assertEquals(3, definition.getCustomFieldOptions().size());
            assertEquals("Option1", definition.getCustomFieldOptions().get(0));
            assertEquals("Option2", definition.getCustomFieldOptions().get(1));
            assertEquals("Option3", definition.getCustomFieldOptions().get(2));
        }
    }

    @Nested
    @DisplayName("JSON Serialization - Single Object Tests")
    class JsonSerializationSingleObjectTests {

        @Test
        @DisplayName("should serialize single definition to JSON")
        void shouldSerializeSingleDefinitionToJson() {
            definition.setCustomFieldName("TechLevel");
            definition.setCustomFieldType(CustomFieldType.INT);
            definition.setCustomFieldWidth("50");

            String json = definition.convertToJson();

            assertNotNull(json);
            assertFalse(json.isEmpty());
            assertTrue(json.contains("TechLevel"));
            assertTrue(json.contains("INT"));
        }

        @Test
        @DisplayName("should round-trip single definition with all fields")
        void shouldRoundTripSingleDefinitionWithAllFields() {
            UUID originalId = definition.getId();
            definition.setCustomFieldName("Population");
            definition.setCustomFieldType(CustomFieldType.LONG);
            definition.setCustomFieldWidth("120");
            definition.setCustomFieldOptions(Arrays.asList("<1M", "1M-100M", "100M-1B", ">1B"));

            String json = definition.convertToJson();

            // Note: toCustomDataDefinition returns a List, so we need to wrap and unwrap
            // For single object testing, we serialize to list
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String listJson = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(listJson);

            assertNotNull(restored);
            assertEquals(1, restored.size());
            CustomDataDefinition restoredDef = restored.get(0);
            assertEquals(originalId, restoredDef.getId());
            assertEquals("Population", restoredDef.getCustomFieldName());
            assertEquals(CustomFieldType.LONG, restoredDef.getCustomFieldType());
            assertEquals("120", restoredDef.getCustomFieldWidth());
            assertEquals(4, restoredDef.getCustomFieldOptions().size());
            assertEquals("<1M", restoredDef.getCustomFieldOptions().get(0));
            assertEquals(">1B", restoredDef.getCustomFieldOptions().get(3));
        }

        @Test
        @DisplayName("should handle definition with TEXT type")
        void shouldHandleDefinitionWithTextType() {
            definition.setCustomFieldName("Notes");
            definition.setCustomFieldType(CustomFieldType.TEXT);
            definition.setCustomFieldWidth("500");

            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertNotNull(restored);
            assertEquals(CustomFieldType.TEXT, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle definition with MULTIPLE type and options")
        void shouldHandleDefinitionWithMultipleTypeAndOptions() {
            definition.setCustomFieldName("Installations");
            definition.setCustomFieldType(CustomFieldType.MULTIPLE);
            definition.setCustomFieldOptions(Arrays.asList(
                    "Military Base",
                    "Antimatter Factory",
                    "Civilian Port",
                    "Fuel Station",
                    "Shopping Mall"
            ));

            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertNotNull(restored);
            assertEquals(CustomFieldType.MULTIPLE, restored.get(0).getCustomFieldType());
            assertEquals(5, restored.get(0).getCustomFieldOptions().size());
            assertTrue(restored.get(0).getCustomFieldOptions().contains("Military Base"));
            assertTrue(restored.get(0).getCustomFieldOptions().contains("Shopping Mall"));
        }
    }

    @Nested
    @DisplayName("JSON Serialization - List Tests")
    class JsonSerializationListTests {

        @Test
        @DisplayName("should serialize list of definitions to JSON")
        void shouldSerializeListOfDefinitionsToJson() {
            CustomDataDefinition def1 = new CustomDataDefinition();
            def1.setCustomFieldName("Field1");
            def1.setCustomFieldType(CustomFieldType.INT);

            CustomDataDefinition def2 = new CustomDataDefinition();
            def2.setCustomFieldName("Field2");
            def2.setCustomFieldType(CustomFieldType.TEXT);

            CustomDataDefinition def3 = new CustomDataDefinition();
            def3.setCustomFieldName("Field3");
            def3.setCustomFieldType(CustomFieldType.DOUBLE);

            List<CustomDataDefinition> list = Arrays.asList(def1, def2, def3);
            String json = definition.convertToJson(list);

            assertNotNull(json);
            assertTrue(json.contains("Field1"));
            assertTrue(json.contains("Field2"));
            assertTrue(json.contains("Field3"));
        }

        @Test
        @DisplayName("should round-trip list of definitions")
        void shouldRoundTripListOfDefinitions() {
            CustomDataDefinition def1 = new CustomDataDefinition();
            def1.setCustomFieldName("TechLevel");
            def1.setCustomFieldType(CustomFieldType.INT);
            def1.setCustomFieldWidth("50");

            CustomDataDefinition def2 = new CustomDataDefinition();
            def2.setCustomFieldName("Population");
            def2.setCustomFieldType(CustomFieldType.LONG);
            def2.setCustomFieldWidth("100");

            CustomDataDefinition def3 = new CustomDataDefinition();
            def3.setCustomFieldName("GovernmentType");
            def3.setCustomFieldType(CustomFieldType.TEXT);
            def3.setCustomFieldOptions(Arrays.asList("Democracy", "Monarchy", "Corporate", "Military"));

            List<CustomDataDefinition> originalList = Arrays.asList(def1, def2, def3);
            String json = definition.convertToJson(originalList);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertNotNull(restored);
            assertEquals(3, restored.size());

            // Check first definition
            assertEquals("TechLevel", restored.get(0).getCustomFieldName());
            assertEquals(CustomFieldType.INT, restored.get(0).getCustomFieldType());

            // Check second definition
            assertEquals("Population", restored.get(1).getCustomFieldName());
            assertEquals(CustomFieldType.LONG, restored.get(1).getCustomFieldType());

            // Check third definition
            assertEquals("GovernmentType", restored.get(2).getCustomFieldName());
            assertEquals(CustomFieldType.TEXT, restored.get(2).getCustomFieldType());
            assertEquals(4, restored.get(2).getCustomFieldOptions().size());
        }

        @Test
        @DisplayName("should handle empty list")
        void shouldHandleEmptyList() {
            List<CustomDataDefinition> emptyList = Arrays.asList();
            String json = definition.convertToJson(emptyList);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertNotNull(restored);
            assertTrue(restored.isEmpty());
        }
    }

    @Nested
    @DisplayName("Error Handling Tests")
    class ErrorHandlingTests {

        @Test
        @DisplayName("should return null for invalid JSON")
        void shouldReturnNullForInvalidJson() {
            List<CustomDataDefinition> result = definition.toCustomDataDefinition("not valid json {{{}");

            assertNull(result);
        }

        @Test
        @DisplayName("should return null for empty string")
        void shouldReturnNullForEmptyString() {
            List<CustomDataDefinition> result = definition.toCustomDataDefinition("");

            assertNull(result);
        }

        @Test
        @DisplayName("should return null for null-like JSON")
        void shouldReturnNullForNullLikeJson() {
            List<CustomDataDefinition> result = definition.toCustomDataDefinition("null");

            assertNull(result);
        }
    }

    @Nested
    @DisplayName("All CustomFieldType Values Tests")
    class AllCustomFieldTypeValuesTests {

        @Test
        @DisplayName("should handle INT type")
        void shouldHandleIntType() {
            definition.setCustomFieldType(CustomFieldType.INT);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.INT, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle LONG type")
        void shouldHandleLongType() {
            definition.setCustomFieldType(CustomFieldType.LONG);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.LONG, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle FLOAT type")
        void shouldHandleFloatType() {
            definition.setCustomFieldType(CustomFieldType.FLOAT);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.FLOAT, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle DOUBLE type")
        void shouldHandleDoubleType() {
            definition.setCustomFieldType(CustomFieldType.DOUBLE);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.DOUBLE, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle TEXT type")
        void shouldHandleTextType() {
            definition.setCustomFieldType(CustomFieldType.TEXT);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.TEXT, restored.get(0).getCustomFieldType());
        }

        @Test
        @DisplayName("should handle MULTIPLE type")
        void shouldHandleMultipleType() {
            definition.setCustomFieldType(CustomFieldType.MULTIPLE);
            List<CustomDataDefinition> list = Arrays.asList(definition);
            String json = definition.convertToJson(list);
            List<CustomDataDefinition> restored = definition.toCustomDataDefinition(json);

            assertEquals(CustomFieldType.MULTIPLE, restored.get(0).getCustomFieldType());
        }
    }
}
